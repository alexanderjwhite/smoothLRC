---
title: "Seurat Integration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Seurat Integration}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Setup

This tutorial will demonstrate how the results of smoothLRC can be integrated into [Seurat](https://satijalab.org/seurat/index.html) for further downstream analysis.

```{r Setup, message=FALSE, warning=FALSE, collapse=TRUE}
library(smoothLRC)
library(dplyr)
library(SummarizedExperiment)
library(ggplot2)
library(Seurat)
set.seed(1)
```

## Load Data

First we load sample 151671 from the DLPFC data with pre-computed smoothLRC metadata.

```{r Load Data, message=FALSE, warning=FALSE}
sce <- readRDS("151671.rds")
clust_1000 <- read.csv("151671.csv", colClasses = "factor")$smooth_cluster_1000
```


## Differential Expression

Next, we will utilize tools from (Seurat)[https://satijalab.org/seurat/] to identify spatially variable features. For demonstration purposes, we select the top three spatially variable features per cluseter. We can visualize these identified features with an individual spatial expression plot both before and after smoothing.

```{r Differential Expression Part 1, fig.height=5, fig.width=5.5, message=FALSE, warning=FALSE}
sce_seurat <- CreateSeuratObject(assay(sce,2), assay = "logcounts")
labels <- levels(clust_1000)
markers <- NULL

for (label in labels){
  region_1 <- clust_1000 == label
  region_2 <- clust_1000 != label
  cells_1 <- colnames(sce)[region_1]
  cells_2 <- colnames(sce)[region_2]
  marker <- FindMarkers(sce_seurat, ident.1 = cells_1, ident.2 = cells_2)
  marker$feature <- rownames(marker)
  markers <- rbind(markers,cbind(marker, cluster = label))
}

all_markers <- unique(markers$feature)
sce_seurat@assays$logcounts@var.features <- all_markers

top_by_cluster <- as_tibble(markers) %>% 
  group_by(cluster) %>% 
  slice_min(order_by = p_val, n = 3)

top_feat <- top_by_cluster %>% 
  pull(feature) 

sce %>% 
  spatial_plot(feature_name = top_feat[1], type = "raw")

sce %>% 
  spatial_plot(feature_name = top_feat[1], type = "smooth")


```

Additionally, we can visualize these features with a heatmap.

```{r Differential Expression Part 2, fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
library(NMF)
cell_order <- tibble(label = clust_1000, order = 1:length(clust_1000)) %>% 
  arrange(label) %>% 
  pull(order)
data_heatmap <- as.matrix(assay(sce, 2)[top_feat,cell_order])
aheatmap(data_heatmap, Rowv = NA, Colv = NA, labCol = NA, 
              annCol = data.frame(Cluster = clust_1000[cell_order]),
              annRow = data.frame(Cluster = top_by_cluster %>% pull(cluster)))

```

Lastly, we can compare

```{r}
raw <- ScaleData(sce_seurat)
raw <- RunPCA(raw, verbose = FALSE)
raw <- RunUMAP(raw, reduction = "pca", dims = 1:30)
DimPlot(raw, reduction = "umap", label = TRUE)

smoothed <- sce@metadata$smooth_u %*% t(sce@metadata$smooth_v)
rownames(smoothed) <- rownames(sce)
colnames(smoothed) <- colnames(sce)
sce_seurat[["smooth"]] <- CreateAssayObject(data = smoothed)
DefaultAssay(sce_seurat) <- "smooth"
```



Reproducibility

```{r Reproducibility, collapse=TRUE}
sessionInfo()
```

